{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="/static/css/home.css">
<link rel="stylesheet" href="/static/css/navbar.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
{% endblock %}


{% block title%}
Ваши места
{% endblock %}

{% block navbar %}
<nav class="navbar">
    <div class="logo">
        <a class="logo-text" href="{% url 'home' %}">Places Remember</a>
    </div>

    <div class="personal-info">
        <div class="avatar">
            <img src="{{ avatar }}"
            width=60 alt="Avatar">
        </div>
        <div class="name">
            {{ name }}
        </div>
        <a class="logout" href="{% url 'logout' %}">
            <img src="/static/img/logout.svg" width="35" alt="Выход">
        </a>
    </div>
</nav>

{% endblock%}

{% block body%}

<iframe id="memory_map" src="/map"></iframe>
<button class="add-button">
    Добавить воспоминание
</button>

{% if location_list|length == 0 %}
    <div class="empty-list">
        У вас нет ни одного воспоминания
    </div>
{% else %}
    <div class="memories">
        <table>
            <tr>
                <th id="table-index">#</th>
                <th id="table-location">Место</th>
                <th id="table-comment">Комментарий</th>
            </tr>
            <tr><td>1</td><td>ИКИТ</td><td>Мой институт</td></tr>
            <tr><td>2</td><td>Остров Татышев</td><td>Мое любимое место</td></tr>
        </table>
    </div>

{% endif %}

<script>
    function delete_add_form(scope) {
        const form = scope.querySelector('.form-window');
        if (form !== null)
            form.remove();
    }
    function create_add_form(scope) {
        delete_add_form(scope);

        const form_wrapper = document.createElement('div')
        form_wrapper.className += "form-window";
        const form = document.createElement('form')
        form.className += "add-form";
        form.method = "post";

        form.innerHTML = `
        {% csrf_token %}
        {{ add_form.place }}
        <hr>
        {{ add_form.description }}
        <input type="submit" value="Добавить" class="form-submit">


        `
        const close_button = document.createElement('a')
        close_button.className += 'close-form';

        close_button.addEventListener("click", function (e) {
            e.stopPropagation();
            delete_add_form(scope);
        });
        const close_icon = document.createElement('img')
        close_icon.src = '/static/img/cross.png'
        close_icon.className += 'close-icon';
        close_button.appendChild(close_icon)

        form_wrapper.appendChild(form);
        form_wrapper.appendChild(close_button);
        form_wrapper.style.position = 'absolute';
        return form_wrapper;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function get_map() {
        return new Promise((resolve) => {
            const iframeContent = document.querySelector('#memory_map').contentDocument;
            resolve(iframeContent.querySelector('iframe').contentDocument);
        })
    }

    async function init_map() {
        await sleep(100).then(async () => {
            await get_map().then((mapContent) => {
                mapContent.head.innerHTML += `<style>
                    .leaflet-popup {display: none}

                    .add-form {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        border-radius: 30px;
                        width: 15em;
                        height: 10em;
                        background-color: #c61c2c;
                        border: 3px solid #454545;
                    }

                    .add-form hr {
                        width: 100%;
                        border-top: 0.1em solid #454545;
                        border-bottom: 0.08em solid #454545;
                        border-right: 0 solid #454545;
                        border-left: 0 solid #454545;
                        background-color: #454545;
                        margin-top: 0.2em;
                        margin-bottom: 0.4em;
                    }

                    .form-place {
                        border-radius: 15px;
                        width: 80%;
                        height: 20%;
                        text-align: center;
                        font: 1.4em "Georgia";
                        background-color: rgba(255, 255, 255, 0.9);
                        margin-top: 0.15em;
                        border: 2px solid #454545;
                    }

                    .form-description {
                        border-radius: 15px;
                        width: 85%;
                        height: 40%;
                        border: 2px solid #454545;
                        font: 1.4em "Georgia";
                        resize: none;
                        background-color: rgba(255, 255, 255, 0.9);
                        margin-bottom: 0.3em;
                        padding: 0.5em;
                    }

                    .form-submit {
                        background-color: rgba(255, 255, 255, 0.9);
                        margin-bottom: 0.25em;
                        width: 45%;
                        height: 20%;
                        border-radius: 15px;
                        font: 1.2em "Georgia";
                        color: #454545;
                    }

                    .close-form {
                        position: relative;
                        bottom: 10.5em;
                        left: 14.7em;
                    }

                    .close-icon {
                        width: 12px;
                        height: 12px;
                    }
                </style>`;
            });
        })
            .catch(init_map)
    }

    function extract_coords(coords_str) {
        const key = '(\\w*)';
        const float = '([+-]?[0-9]*[.]?[0-9]+)';
        const re = new RegExp(`${key}: ${float}<br>${key}: ${float}`);

        const coords_arr = re.exec(coords_str).slice(1, 5);
        return {latitude: coords_arr[1], longitude: coords_arr[3]}
    }

    init_map().then(async () => {
        const observer = new MutationObserver(async mutationRecords => {
            await get_map().then((mapContent) => {
                if (mutationRecords[0].removedNodes.length === 0) {
                    const popup = mutationRecords[0].target.querySelector('.leaflet-popup');
                    const coords_html = popup.querySelector('.leaflet-popup-content').innerHTML;
                    const coords = extract_coords(coords_html);
                    const form = create_add_form(mapContent);
                    form.style.transform = popup.style.transform;
                    popup.replaceWith(form);

                    console.log(coords);
                }
            })
        });

        async function get_observer() {
            await sleep(100).then(async () => {
                await get_map().then((mapContent) => {
                    observer.observe(mapContent.querySelector('.leaflet-pane .leaflet-popup-pane'), {
                        childList: true,
                        attributes: false,
                        characterData: false,
                    });
                });
            })
                .catch(get_observer)
        }

        await get_observer()
    })
</script>
{% endblock %}